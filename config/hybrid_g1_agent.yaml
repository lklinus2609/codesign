# PGHC (Performance-Gated Hybrid Co-Design) Agent Configuration
# Implements Algorithm 1 from the thesis
#
# Reference: Masters_Thesis.pdf, Section II.D

agent_name: "PGHC_AMP"

# ============================================================================
# Base AMP/PPO Configuration (Inner Loop)
# ============================================================================

model:
  actor_net: "fc_2layers_1024units"
  actor_init_output_scale: 0.01
  actor_std_type: "FIXED"
  action_std: 0.05

  critic_net: "fc_2layers_1024units"

  disc_net: "fc_2layers_1024units"

optimizer:
    type: "SGD"
    learning_rate: 5e-5

discount: 0.99
steps_per_iter: 32
iters_per_output: 100
test_episodes: 32
normalizer_samples: 100000000

update_epochs: 5
batch_size: 4
td_lambda: 0.95
ppo_clip_ratio: 0.2
norm_adv_clip: 4.0
action_bound_weight: 10.0
action_entropy_weight: 0.0
action_reg_weight: 0.0
critic_loss_weight: 1.0

# AMP Discriminator
disc_buffer_size: 200000
disc_replay_samples: 1000
disc_batch_size: 2048
disc_loss_weight: 5
disc_logit_reg: 0.01
disc_grad_penalty: 5
disc_weight_decay: 0.0001
disc_reward_scale: 2

task_reward_weight: 0.0
disc_reward_weight: 1.0

# ============================================================================
# PGHC Outer Loop Gating Mode
# ============================================================================
# "stability": Performance-gated triggering (Algorithm 1, recommended)
#   - Outer loop triggers when policy converges (delta_rel < delta_conv)
#   - Enforces Envelope Theorem approximation validity
# "fixed": Legacy warmup + frequency schedule
#   - Uses warmup_iters and outer_loop_freq parameters
gating_mode: "stability"

# ============================================================================
# Stability Gating Parameters (Algorithm 1, Lines 12-18)
# ============================================================================

# Window W for moving average returns (default: 100 episodes)
# Larger window = more stable metric but slower detection
stability_window: 100

# Convergence threshold delta_conv (default: 5% relative change)
# Lower = stricter convergence requirement
# delta_rel = |R_t - R_{t-W}| / (|R_{t-W}| + epsilon)
stability_threshold: 0.05

# Small epsilon to prevent division by zero
stability_epsilon: 1.0e-8

# Minimum iterations before stability check can pass
# Ensures enough data for reliable metric
min_iters_for_stability: 200

# ============================================================================
# Legacy Fixed Schedule Parameters (for gating_mode: "fixed")
# ============================================================================

# Number of inner loop iterations before outer loop activates
warmup_iters: 10000

# Frequency of outer loop updates (every N inner iterations)
outer_loop_freq: 200

# ============================================================================
# Adaptive Trust Region Parameters (Algorithm 1, Lines 24-35)
# ============================================================================

# Initial design learning rate (beta_init)
design_learning_rate: 0.01

# Learning rate bounds
design_lr_min: 1.0e-5
design_lr_max: 0.1

# Trust region threshold xi (10% performance degradation allowed)
# D <= xi * |J(phi_k)| for acceptance
trust_region_threshold: 0.1

# Learning rate adaptation factors
lr_decay_factor: 0.5    # Shrink on trust region violation
lr_growth_factor: 1.5   # Grow on small improvement

# Maximum trust region iterations before giving up
max_trust_region_iters: 10

# Threshold for "small improvement" (triggers LR growth)
small_improvement_threshold: 0.01

# ============================================================================
# Differentiable Rollout Parameters
# ============================================================================

# Horizon for differentiable rollout (H in Algorithm 1)
# Note: Keep SHORT (<=5) due to contact force instability in SolverSemiImplicit
# The robot falls and contacts ground around step 3-4, causing gradient issues
diff_horizon: 3

# ============================================================================
# Design Parameter Configuration (Morphology)
# ============================================================================

# Initial design parameter value (radians)
# 0.0 = neutral hip roll angle (feet parallel)
design_param_init: 0.0

# Bounds for design parameter (radians)
# Thesis uses +/- 30 degrees = +/- 0.5236 radians
design_param_min: -0.5236
design_param_max: 0.5236

# ============================================================================
# Logging and Checkpointing
# ============================================================================

# Log design parameter history
log_design_history: true

# Save intermediate models during outer loop
save_outer_loop_models: true
